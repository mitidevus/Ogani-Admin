<div>
    <div class="container-fluid">
        <div id="search-form" class="row mt-3 justify-content-start">

            <div class="col-12 col-md-6 col-xl-8 mb-3">
                <div class="d-flex">
                    <a class="btn btn-primary btn-block gradient-custom-4" href="/product/add">
                        <i class="fas fa-plus-circle"></i>
                        Add product
                    </a>
                    <div class="filter__sort ms-3">
                        <div class="sort-list">
                                    <span class="sort-item">Sort by</span>
                                    <ul class="sort-by">
                                        <li><a href="" id="price-asc" class="sort-item">Price:
                                                <span class="fw-bold">Ascending</span></a></li>
                                        <li><a href="" id="price-desc" class="sort-item">Price:
                                                <span class="fw-bold">Descending</span></a></li>
                                        <li><a href="" id="star-asc" class="sort-item">Rate star:
                                                <span class="fw-bold">Ascending</span></a></li>
                                        <li><a href="" id="star-desc" class="sort-item">Rate star:
                                                <span class="fw-bold">Descending</span></a></li>
                                    </ul>
                                </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-xl-4 mb-3">
                <div class="p-1 bg-light rounded rounded-pill shadow-lg d-flex justify-content-end">
                    <div class="input-group">
                        <input
                            id="myInput"
                            type="search"
                            onkeyup="mySearchFunction()"
                            placeholder="Enter product name to search"
                            aria-describedby="btn-search"
                            class="form-control border-0 bg-light"
                        />
                        <div class="input-group-append">
                            <button id="btn-search" class="btn btn-link text-primary"><i
                                    class="fa fa-search"
                                ></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="table-responsive">
            <table id="myTable" class="table table-hover table-striped table-bordered">
                <thead class="text-center">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Image</th>
                        <th>Category</th>
                        <th>Brand</th>
                        <th>Star</th>
                        <th>Adjust</th>
                    </tr>
                </thead>

                <tbody id="list_product">
                    {{#each listProducts.data}}
                        <tr>
                            <td>{{this.name}}</td>
                            <td>{{this.description}}</td>
                            <td class="text-center">{{this.remain_Amount}}</td>
                            <td class="text-center">{{this.price}}</td>
                            <td>
                                <img
                                    src="{{this.image}}"
                                    class="thumbnail img-responsive"
                                    alt="image"
                                    width="100"
                                    height="100"
                                    style="border-radius: 10px;"
                                />
                            </td>
                            <td class="text-center">{{this.category_name}}</td>
                            <td class="text-center">{{this.brand_name}}</td>
                            <td class="text-center">{{this.rate_Star}}</td>
                            <td>
                                <div class="center">
                                    <a href="/product">
                                        <i class="far fa-edit" title="Chỉnh sửa sản phẩm"></i>
                                    </a>

                                    <a href="/product" onclick="return confirm('Bạn có muốn xóa không?')">
                                        <i
                                            class="fas fa-trash"
                                            style="margin-left: 30px; color: red"
                                            title="Xóa sản phẩm"
                                        ></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>

    <p id="total_page" style="display: none;">{{listProducts.total_page}}</p>
    <div id="page_component" class="d-flex justify-content-center product__pagination">
    </div>

    {{! <div class="center">
        <div class="mb-2">
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="page-item disabled">
                        <a class="page-link" href="/product" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>
                    <li class="page-item active">
                        <a class="page-link" href="/product">1</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="/product">2</a>
                    </li>

                    <li class="page-item">
                        <a class="page-link" href="/product" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                            <span class="sr-only">Next</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div> }}
</div>

<script>
    let total_page= document.getElementById("total_page").innerText
    let pageComponent = document.getElementById("page_component")
    
    let list_product= document.getElementById("list_product")
    let preCateID=0;
    let preNameSearch='';
    let preSort='';
    let preMin=0;
    let preMax=0;
    function load_product_page(page=1, cate_id=preCateID, name=preNameSearch, sort=preSort, min=preMin, max=preMax){
        console.log(page, cate_id, typeof name)
        
        let htmlListProduct=``
        $.getJSON(`/api/product?page=${page}&cate_id=${cate_id||''}&name=${name||''}&sort=${sort||''}&min=${min||''}&max=${max||''}`, function (products) {
            const data= products.data.map(v=>{
                v.price = v.price.toLocaleString('it-IT', { style: 'currency', currency: 'VND' });
                return `
                    <tr>
                        <td>${v.name}</td>
                        <td>${v.description}</td>
                        <td class="text-center">${v.remain_Amount}</td>
                        <td class="text-center">${v.price}</td>
                        <td>
                            <img
                                src="${v.image}"
                                class="thumbnail img-responsive"
                                alt="image"
                                width="100"
                                height="100"
                                style="border-radius: 10px;"
                            />
                        </td>
                        <td class="text-center">${v.category_name}</td>
                        <td class="text-center">${v.brand_name}</td>
                        <td class="text-center">${v.rate_Star}</td>

                        <td>
                            <div class="center">
                                <a href="/product">
                                    <i class="far fa-edit" title="Chỉnh sửa sản phẩm"></i>
                                </a>
                                <a href="/product" onclick="return confirm('Bạn có muốn xóa không?')">
                                    <i
                                        class="fas fa-trash"
                                        style="margin-left: 30px; color: red"
                                        title="Xóa sản phẩm"
                                    ></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                `
            })
            htmlListProduct= data.join("")
            list_product.innerHTML= htmlListProduct
            if (cate_id){
                if (preCateID!==cate_id){
                    renderPage(products.total_page, cate_id, name, sort)
                    preCateID= cate_id;
                }  
                
            }
            if (name){
                if (name!==preNameSearch){
                    renderPage(products.total_page, cate_id, name, sort)
                }
                    preNameSearch= name;
                
            }
            if (sort){
                if (sort!==preSort){
                    renderPage(products.total_page, cate_id, name, sort)
                    preSort= sort;
                }
                
            }
            if (min){
                if (max!=preMax){
                    renderPage(products.total_page, cate_id, name, sort, min, max)
                    preMax= max;
                }
                if (min!=preMin){
                    renderPage(products.total_page, cate_id, name, sort, min, max)
                    preMin= min;
                }
            }
        });
    }
    
    /*
    //handle form search
    let btn_submit_search= document.getElementById("btn_submit_search")
    let name_search= document.getElementById("name_search")
    btn_submit_search.addEventListener("click", ()=>{
        let name= name_search.value
        
        load_product_page(1, preCateID, name, preSort, preMin, preMax)
    })
    
    //handle price 
    let btn_search_slider = document.getElementById("btn-search-slider-price")
    let minamount= document.getElementById("minamounth")
    let maxamount= document.getElementById("maxamounth")
    btn_search_slider.addEventListener("click", ()=>{
        let min = minamount.value || 0
        let max = maxamount.value || 0
        if (max>min){
            load_product_page(1, preCateID, preNameSearch, preSort, min, max)
        }else {
            alert("Invalid price")
        }                        
    })
    */

    //handle sort
    let price_asc = document.getElementById("price-asc")
    let price_desc = document.getElementById("price-desc")
    let star_asc = document.getElementById("star-asc")
    let star_desc = document.getElementById("star-desc")
    
    price_asc.addEventListener('click', (e)=>{
        e.preventDefault()
        load_product_page(1, preCateID, preNameSearch, 'price-asc', preMin, preMax)
    })
    price_desc.addEventListener('click', (e)=>{
        e.preventDefault()
        load_product_page(1, preCateID, preNameSearch, 'price-desc', preMin, preMax)
    })
    star_asc.addEventListener('click', (e)=>{
        e.preventDefault()
        load_product_page(1, preCateID, preNameSearch, 'rate-star-asc', preMin, preMax)
    })
    star_desc.addEventListener('click', (e)=>{
        e.preventDefault()
        load_product_page(1, preCateID, preNameSearch, 'rate-star-desc', preMin, preMax)
    })
    
    function renderPage(total_page=1, cate_id=0, name, sort, min, max){
        let pagingHtml= ``
        for (let i=1; i<= Number(total_page); i++){
            pagingHtml+= `
                <a href=""
            class="currentPage" onclick="load_product_page(${i}, ${cate_id}, '${name||''}', '${sort||''}', ${min}, ${max})">${i}</a>
            `
        }
        pageComponent.innerHTML= pagingHtml
        activePage()
    }
    renderPage(total_page)
    function activePage(){
        let pages= document.getElementsByClassName("currentPage")
        let prePage= pages[0];
        prePage.classList.add("is_active")
        for (let page of pages){
            page.addEventListener('click', (e)=>{
                e.preventDefault()
                e.target.classList.add("is_active")
                prePage.classList.remove("is_active")
                prePage= page
            })
        }
    }
    {{!-- activePage() --}}
    /*
    let categories= document.getElementsByClassName("currentCategory")
    let preCate= categories[0];
    {{!-- preCate.classList.add("is_active") --}}
    for (let cate of categories){
        cate.addEventListener('click', (e)=>{
            e.preventDefault()
            e.target.classList.add("is_active")
            preCate.classList.remove("is_active")
            preCate= cate
        })
    }
    */
</script>